<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Taxi Bill Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:#fffbeb;color:#1e293b;min-height:100vh;line-height:1.5;overflow-x:hidden;}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:#fde68a;border-radius:3px;}
.hidden{display:none!important;}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.nav{display:flex;align-items:center;justify-content:space-between;padding:0 40px;height:64px;background:#fff;border-bottom:1.5px solid #fde68a;position:sticky;top:0;z-index:200;}
.nav-logo{display:flex;align-items:center;gap:10px;font-size:1rem;font-weight:800;color:#1e293b;}
.logo-icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#f59e0b,#d97706);display:flex;align-items:center;justify-content:center;font-size:1.1rem;box-shadow:0 4px 12px rgba(245,158,11,0.35);}
.nav-sub{color:#94a3b8;font-weight:500;font-size:0.78rem;}
.tab-btns{display:flex;gap:4px;background:#fffbeb;padding:4px;border-radius:12px;border:1.5px solid #fde68a;}
.tab-btn{background:none;border:none;color:#92400e;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.82rem;font-weight:700;padding:8px 20px;border-radius:9px;cursor:pointer;transition:all 0.2s;}
.tab-btn.active{background:#fff;color:#b45309;box-shadow:0 1px 6px rgba(0,0,0,0.08);}
.tab-btn:hover:not(.active){color:#78350f;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.page{display:none;max-width:840px;margin:0 auto;padding:36px 28px 80px;position:relative;z-index:10;}
.page.active{display:block;animation:fadeUp 0.35s cubic-bezier(.22,.68,0,1.2) both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.section-header{background:#fff;border:1.5px solid #fde68a;border-radius:18px;padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;gap:16px;box-shadow:0 2px 10px rgba(245,158,11,0.08);}
.sh-icon{width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,#f59e0b,#d97706);display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;box-shadow:0 4px 14px rgba(245,158,11,0.3);}
.sh-title{font-size:1.15rem;font-weight:800;color:#1e293b;margin-bottom:3px;}
.sh-sub{font-size:0.82rem;color:#64748b;}

/* ‚îÄ‚îÄ FORM CARDS ‚îÄ‚îÄ */
.form-card{background:#fff;border:1.5px solid #e2e8f0;border-radius:18px;padding:24px 26px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.04);transition:border-color 0.2s;}
.form-card:hover{border-color:#fde68a;}
.section-label{display:flex;align-items:center;gap:8px;font-size:0.68rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#b45309;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid #fef9c3;}
.section-label .dot{width:6px;height:6px;border-radius:50%;background:#f59e0b;flex-shrink:0;}

.form-row{display:grid;gap:14px;margin-bottom:14px;}
.form-row.col2{grid-template-columns:1fr 1fr;}
.form-row.col3{grid-template-columns:1fr 1fr 1fr;}
.form-row.col1{grid-template-columns:1fr;}
label{font-size:0.76rem;font-weight:700;color:#374151;display:block;margin-bottom:5px;}
label .hint{font-weight:500;color:#94a3b8;font-size:0.7rem;}
input,select{width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;color:#1e293b;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.9rem;padding:11px 14px;border-radius:10px;outline:none;transition:all 0.2s;appearance:none;}
input:focus,select:focus{border-color:#f59e0b;background:#fffbeb;box-shadow:0 0 0 3px rgba(245,158,11,0.12);}
input::placeholder{color:#cbd5e1;}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='none'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23f59e0b' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px;background-color:#f8fafc;}

/* ‚îÄ‚îÄ RESULT CARD ‚îÄ‚îÄ */
.result-card{background:#fff;border:1.5px solid #fde68a;border-radius:18px;padding:24px;margin-bottom:14px;box-shadow:0 4px 16px rgba(245,158,11,0.1);}
.result-card::before{content:'';display:block;height:3px;background:linear-gradient(90deg,#f59e0b,#fbbf24,#fcd34d);border-radius:3px;margin-bottom:20px;margin:-24px -24px 20px -24px;border-radius:16px 16px 0 0;}
.result-title{font-size:0.68rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#b45309;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.result-line{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid #f1f5f9;font-size:0.88rem;}
.result-line:last-of-type{border-bottom:none;}
.result-line .lbl{color:#64748b;font-weight:500;}
.result-line .val{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:0.9rem;color:#1e293b;}
.result-line .val.green{color:#059669;}
.result-line .val.yellow{color:#d97706;}
.result-line .val.red{color:#dc2626;}
.divider-line{border:none;border-top:1.5px dashed #f1f5f9;margin:8px 0;}
.payable-row{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:linear-gradient(135deg,#fffbeb,#fef9c3);border:1.5px solid #fde68a;border-radius:12px;margin-top:16px;}
.payable-row .lbl{font-weight:800;font-size:1rem;color:#1e293b;}
.payable-row .val{font-family:'JetBrains Mono',monospace;font-weight:900;font-size:1.6rem;color:#d97706;}
.note-box{background:#fffbeb;border:1.5px solid #fde68a;border-radius:10px;padding:12px 16px;font-size:0.82rem;color:#92400e;margin-top:14px;line-height:1.7;}
.note-box ul{margin-left:18px;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-row{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;}
.btn{font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:0.88rem;padding:11px 24px;border-radius:10px;border:none;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:7px;}
.btn-primary{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;box-shadow:0 4px 14px rgba(245,158,11,0.35);}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(245,158,11,0.45);}
.btn-success{background:linear-gradient(135deg,#10b981,#059669);color:#fff;box-shadow:0 4px 14px rgba(16,185,129,0.25);}
.btn-success:hover{transform:translateY(-1px);}
.btn-outline{background:#fff;border:1.5px solid #e2e8f0;color:#64748b;}
.btn-outline:hover{background:#f8fafc;color:#1e293b;border-color:#cbd5e1;}
.btn-danger{background:#fef2f2;border:1.5px solid #fecaca;color:#ef4444;font-size:0.8rem;padding:7px 14px;}
.btn-danger:hover{background:#fee2e2;}

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
.history-empty{text-align:center;padding:70px 20px;color:#94a3b8;}
.history-empty .icon{font-size:3.5rem;margin-bottom:14px;}
.export-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding:14px 18px;background:#fff;border:1.5px solid #fde68a;border-radius:14px;box-shadow:0 1px 4px rgba(0,0,0,0.04);}
.count-badge{font-size:0.85rem;font-weight:700;color:#1e293b;}
.count-badge span{color:#d97706;font-family:'JetBrains Mono',monospace;}
.history-item{background:#fff;border:1.5px solid #e2e8f0;border-radius:16px;padding:0;margin-bottom:10px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.04);}
.history-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:linear-gradient(180deg,#f59e0b,#d97706);border-radius:4px 0 0 4px;}
.history-item:hover{border-color:#fde68a;box-shadow:0 4px 16px rgba(245,158,11,0.12);transform:translateY(-1px);}
.history-item.expanded{border-color:#fbbf24;box-shadow:0 4px 20px rgba(245,158,11,0.15);}
.hi-top{padding:18px 20px 18px 24px;display:flex;justify-content:space-between;align-items:flex-start;gap:16px;}
.hi-meta{flex:1;}
.hi-bill{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:#d97706;margin-bottom:5px;font-weight:600;}
.hi-title{font-weight:800;font-size:0.98rem;color:#1e293b;margin-bottom:8px;}
.hi-tags{display:flex;gap:6px;flex-wrap:wrap;}
.tag{font-size:0.68rem;font-weight:700;padding:3px 10px;border-radius:20px;background:#fef9c3;color:#92400e;border:1px solid #fde68a;}
.tag.green{background:#dcfce7;color:#166534;border-color:#bbf7d0;}
.tag.yellow{background:#fef9c3;color:#92400e;border-color:#fde68a;}
.tag.teal{background:#ecfeff;color:#155e75;border-color:#a5f3fc;}
.hi-amount{text-align:right;flex-shrink:0;}
.hi-amount .payable{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:900;color:#d97706;}
.hi-amount .label{font-size:0.7rem;color:#94a3b8;margin-top:2px;}
.hi-detail{padding:0 20px 18px 24px;border-top:1.5px solid #fef9c3;display:none;}
.hi-detail.show{display:block;animation:fadeUp 0.2s ease both;}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:14px;}
.dg-item{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:10px 14px;}
.dg-item .dg-lbl{font-size:0.66rem;color:#94a3b8;margin-bottom:3px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;}
.dg-item .dg-val{font-size:0.88rem;font-weight:700;color:#1e293b;}
.hi-actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end;}

/* ‚îÄ‚îÄ BG BLOBS ‚îÄ‚îÄ */
.bg-blob{position:fixed;border-radius:50%;filter:blur(80px);pointer-events:none;z-index:0;}
.blob1{width:500px;height:500px;background:rgba(245,158,11,0.08);top:-100px;right:-80px;}
.blob2{width:350px;height:350px;background:rgba(251,191,36,0.05);bottom:-60px;left:-60px;}

@media(max-width:640px){
  .nav{padding:0 16px;}
  .nav-sub{display:none;}
  .page{padding:24px 16px 60px;}
  .form-row.col2,.form-row.col3{grid-template-columns:1fr;}
  .detail-grid{grid-template-columns:1fr;}
  .tab-btn{padding:8px 12px;}
}
</style>
</head>
<body>

<div class="bg-blob blob1"></div>
<div class="bg-blob blob2"></div>

<div class="nav">
  <div style="display:flex;align-items:center;gap:12px;">
    <a href="index.html" style="display:inline-flex;align-items:center;gap:6px;background:#fffbeb;border:1.5px solid #fde68a;color:#b45309;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.8rem;font-weight:700;padding:7px 16px;border-radius:10px;text-decoration:none;">‚Üê Home</a>
    <div class="nav-logo">
      <div class="logo-icon">üöñ</div>
      Taxi Bill Calculator
      <span class="nav-sub">by Mohan Deist</span>
    </div>
  </div>
  <div class="tab-btns">
    <button class="tab-btn active" onclick="showTab('calculator',this)">‚úö New Entry</button>
    <button class="tab-btn" onclick="showTab('history',this)">üìã History</button>
  </div>
</div>

<!-- CALCULATOR PAGE -->
<div class="page active" id="tab-calculator" style="position:relative;z-index:1;">

  <div class="section-header">
    <div class="sh-icon">üßæ</div>
    <div>
      <div class="sh-title">New Bill Entry</div>
      <div class="sh-sub">Fill in journey details to calculate the payable amount. The meter never lies.</div>
    </div>
  </div>

  <div class="form-card">
    <div class="section-label"><span class="dot"></span>Basic Information</div>
    <div class="form-row col2">
      <div>
        <label>Vendor Name</label>
        <select id="vendorSelect" onchange="handleVendorChange()">
          <option value="">‚Äî Select Vendor ‚Äî</option>
          <option>Mavi Tour &amp; Travels</option>
          <option>Samrat Taxi</option>
          <option>Mohan Travels</option>
          <option value="__other__">Other (enter name)</option>
        </select>
        <input type="text" id="vendorOther" class="hidden" placeholder="Enter vendor name‚Ä¶" style="margin-top:8px;"/>
      </div>
      <div>
        <label>Bill No.</label>
        <input type="text" id="billNo" placeholder="e.g. INV-2024-001"/>
      </div>
    </div>
    <div class="form-row col2">
      <div><label>Bill Date</label><input type="date" id="billDate"/></div>
      <div><label>Passenger Name(s)</label><input type="text" id="passengers" placeholder="e.g. Rajesh Kumar, Priya Singh"/></div>
    </div>
    <div class="form-row col2">
      <div><label>Destination</label><input type="text" id="destination" placeholder="e.g. Mussoorie, Agra"/></div>
      <div>
        <label>Purpose of Visit</label>
        <select id="purposeOfVisit" onchange="handlePurposeChange()">
          <option value="">‚Äî Select Purpose ‚Äî</option>
          <option value="Exam Observer">Exam Observer</option>
          <option value="Venue Audit">Venue Audit</option>
          <option value="Flying Squad">Flying Squad</option>
          <option value="Control Room Cab">Control Room Cab</option>
          <option value="__other__">Other (enter purpose)</option>
        </select>
        <input type="text" id="purposeOther" class="hidden" placeholder="Enter purpose‚Ä¶" style="margin-top:8px;"/>
      </div>
    </div>
  </div>

  <div class="form-card">
    <div class="section-label"><span class="dot"></span>Journey Details</div>
    <div class="form-row col2">
      <div>
        <label>Type of Service</label>
        <select id="serviceType" onchange="handleServiceChange()">
          <option value="">‚Äî Select Service ‚Äî</option>
          <option value="local">Local</option>
          <option value="outstation_plain">Outstation (Plain)</option>
          <option value="outstation_hilly">Outstation (Hilly)</option>
        </select>
      </div>
      <div>
        <label>Type of Vehicle</label>
        <select id="vehicleType" onchange="recalculate()">
          <option value="">‚Äî Select Vehicle ‚Äî</option>
          <option value="sedan">Sedan</option>
          <option value="crysta">Crysta</option>
        </select>
      </div>
    </div>
    <div class="form-row col2">
      <div><label>Journey Start Date</label><input type="date" id="journeyStartDate" onchange="recalculate()"/></div>
      <div><label>Journey Start Time <span class="hint">Optional</span></label><input type="time" id="journeyStartTime" onchange="recalculate()"/></div>
    </div>
    <div class="form-row col2">
      <div><label>Journey End Date</label><input type="date" id="journeyEndDate" onchange="recalculate()"/></div>
      <div><label>Journey End Time <span class="hint">Optional</span></label><input type="time" id="journeyEndTime" onchange="recalculate()"/></div>
    </div>
    <div id="localFields" class="hidden">
      <div class="form-row col2">
        <div><label>Kilometers Travelled</label><input type="number" id="localKm" min="0" placeholder="e.g. 95" oninput="recalculate()"/></div>
        <div><label>Hours Used</label><input type="number" id="localHrs" min="0" step="0.5" placeholder="e.g. 9" oninput="recalculate()"/></div>
      </div>
    </div>
    <div id="outstationFields" class="hidden">
      <div class="form-row col1">
        <div><label>Total Kilometers Travelled</label><input type="number" id="outstationKm" min="0" placeholder="e.g. 320" oninput="recalculate()"/></div>
      </div>
    </div>
    <div class="form-row col1" style="margin-top:4px;">
      <div><label>Amount Claimed by Vendor (‚Çπ)</label><input type="number" id="vendorClaimed" min="0" placeholder="e.g. 3200" oninput="recalculate()"/></div>
    </div>
    <div class="form-row col2" style="margin-top:4px;">
      <div><label>GST (%)</label><input type="number" id="gstPercent" min="0" max="100" step="0.01" placeholder="e.g. 5 or 12" oninput="recalculate()"/></div>
      <div><label>Toll Tax / Parking (‚Çπ) <span class="hint">GST not applicable</span></label><input type="number" id="tollParking" min="0" placeholder="e.g. 250" oninput="recalculate()"/></div>
    </div>
  </div>

  <div class="result-card hidden" id="resultCard">
    <div class="result-title">üìä Fare Breakdown</div>
    <div id="resultLines"></div>
    <div class="payable-row">
      <div class="lbl">Amount Payable</div>
      <div class="val" id="payableAmount">‚Çπ0</div>
    </div>
    <div class="note-box hidden" id="noteBox"></div>
  </div>

  <div class="btn-row">
    <button class="btn btn-primary" onclick="recalculate()">‚ü≥ Calculate</button>
    <button class="btn btn-success hidden" id="saveBtn" onclick="saveEntry()">‚úì Save Entry</button>
    <button class="btn btn-outline" onclick="clearForm()">‚úï Clear</button>
  </div>
</div>

<!-- HISTORY PAGE -->
<div class="page" id="tab-history" style="position:relative;z-index:1;">
  <div class="section-header">
    <div class="sh-icon">üìö</div>
    <div>
      <div class="sh-title">Bill History</div>
      <div class="sh-sub">All saved travel bills. Click any entry to expand full details.</div>
    </div>
  </div>
  <div class="export-bar">
    <span class="count-badge" id="countBadge"><span>0</span> entries saved</span>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-outline" onclick="exportCSV()">‚Üì CSV</button>
      <button class="btn btn-outline" onclick="exportJSON()">‚Üì JSON</button>
    </div>
  </div>
  <div id="historyList"></div>
</div>

<script>
const GOOGLE_SHEET_URL='https://script.google.com/macros/s/AKfycbyOyOcN3uCi2Igug1EHQ5dslfjHSqWIS7vG4V4zRGLutqhAa1VU7BLwmtUrh8HOg34R8Q/exec';
let entries=JSON.parse(localStorage.getItem('travelbill_entries')||'[]');
let currentCalc=null;

function showTab(name,el){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById('tab-'+name).classList.add('active');if(el)el.classList.add('active');if(name==='calculator')clearForm();if(name==='history')renderHistory();}
function handleVendorChange(){const v=document.getElementById('vendorSelect').value;document.getElementById('vendorOther').classList.toggle('hidden',v!=='__other__');}
function handlePurposeChange(){const v=document.getElementById('purposeOfVisit').value;document.getElementById('purposeOther').classList.toggle('hidden',v!=='__other__');}
function getPurpose(){const sel=document.getElementById('purposeOfVisit').value;if(sel==='__other__')return document.getElementById('purposeOther').value.trim();return sel;}
function handleServiceChange(){const svc=document.getElementById('serviceType').value;document.getElementById('localFields').classList.toggle('hidden',svc!=='local');document.getElementById('outstationFields').classList.toggle('hidden',!svc.startsWith('outstation'));recalculate();}
function getVendorName(){const sel=document.getElementById('vendorSelect');if(sel.value==='__other__')return document.getElementById('vendorOther').value.trim();if(sel.value==='')return'';return sel.options[sel.selectedIndex].text;}
function isNightTime(dt){if(!dt)return false;const h=dt.getHours();return h>=22||h<6;}
function checkNightAllowance(s,e){if(!s||!e)return false;return isNightTime(new Date(s))||isNightTime(new Date(e));}
function getDaysBetween(s,e){if(!s||!e)return 0;const start=new Date(s),end=new Date(e);if(end-start<=0)return 0;const sd=new Date(start.getFullYear(),start.getMonth(),start.getDate());const ed=new Date(end.getFullYear(),end.getMonth(),end.getDate());return Math.floor((ed-sd)/86400000);}

function recalculate(){
  const svc=document.getElementById('serviceType').value;
  const veh=document.getElementById('vehicleType').value;
  const claimed=parseFloat(document.getElementById('vendorClaimed').value)||0;
  
  // Combine date + time inputs
  const startDate=document.getElementById('journeyStartDate').value;
  const startTime=document.getElementById('journeyStartTime').value||'00:00';
  const endDate=document.getElementById('journeyEndDate').value;
  const endTime=document.getElementById('journeyEndTime').value||'23:59';
  const startStr=startDate?(startDate+'T'+startTime):'';
  const endStr=endDate?(endDate+'T'+endTime):'';
  
  if(!svc||!veh){hideResult();return;}
  let breakdown=[],calculated=0,notes=[];
  if(svc==='local'){
    const km=parseFloat(document.getElementById('localKm').value)||0;
    const hrs=parseFloat(document.getElementById('localHrs').value)||0;
    if(!km&&!hrs){hideResult();return;}
    const baseKm=80,baseHrs=8;
    let baseRate,extraKmRate,extraHrRate;
    if(veh==='sedan'){baseRate=2100;extraKmRate=18;extraHrRate=150;}
    else{baseRate=2500;extraKmRate=24;extraHrRate=225;} // Crysta: 225/hr
    breakdown.push({lbl:`Base Package (${baseHrs} hrs / ${baseKm} km)`,val:`‚Çπ${baseRate.toLocaleString()}`});
    calculated+=baseRate;
    const extraKm=Math.max(0,km-baseKm);
    if(extraKm>0){const a=extraKm*extraKmRate;breakdown.push({lbl:`Extra Km: ${extraKm} km √ó ‚Çπ${extraKmRate}`,val:`+‚Çπ${a.toLocaleString()}`});calculated+=a;}
    const extraHrs=Math.max(0,hrs-baseHrs);
    if(extraHrs>0){const a=extraHrs*extraHrRate;breakdown.push({lbl:`Extra Hours: ${extraHrs} hrs √ó ‚Çπ${extraHrRate}`,val:`+‚Çπ${a.toLocaleString()}`});calculated+=a;}
  } else {
    const km=parseFloat(document.getElementById('outstationKm').value)||0;
    if(!km){hideResult();return;}
    const pricePerKm=svc==='outstation_plain'?(veh==='sedan'?18:24):(veh==='sedan'?21:28);
    const minKm=250;
    const tripDays=Math.max(1,getDaysBetween(startStr,endStr)+1);
    const minKmTotal=minKm*tripDays;
    const billedKm=Math.max(km,minKmTotal);
    const kmCharge=billedKm*pricePerKm;
    if(km<minKmTotal){notes.push(`Minimum billing: ${minKm} km/day √ó ${tripDays} day${tripDays>1?'s':''} = ${minKmTotal} km (actual: ${km} km)`);breakdown.push({lbl:`Distance: ${minKmTotal} km (min ${minKm}√ó${tripDays}d) √ó ‚Çπ${pricePerKm}/km`,val:`‚Çπ${kmCharge.toLocaleString()}`});}
    else{breakdown.push({lbl:`Distance: ${km} km √ó ‚Çπ${pricePerKm}/km`,val:`‚Çπ${kmCharge.toLocaleString()}`});}
    calculated+=kmCharge;
    if(checkNightAllowance(startStr,endStr)){breakdown.push({lbl:'Night Allowance (before 6AM / after 10PM)',val:'+‚Çπ300',cls:'yellow'});calculated+=300;notes.push('Night allowance applied.');}
    const holdDays=getDaysBetween(startStr,endStr);
    if(holdDays>0){const a=holdDays*300;breakdown.push({lbl:`Vehicle Holding (${holdDays} day${holdDays>1?'s':''} √ó ‚Çπ300)`,val:`+‚Çπ${a.toLocaleString()}`,cls:'yellow'});calculated+=a;notes.push(`Vehicle holding: ${holdDays} night(s) √ó ‚Çπ300.`);}
  }
  const gstPercent=parseFloat(document.getElementById('gstPercent').value)||0;
  const tollParking=parseFloat(document.getElementById('tollParking').value)||0;
  breakdown.push({divider:true});
  breakdown.push({lbl:'Sub-total (Transport)',val:`‚Çπ${calculated.toLocaleString()}`,cls:'green'});
  let gstAmount=0;
  if(gstPercent>0){gstAmount=Math.round(calculated*gstPercent/100);breakdown.push({lbl:`GST @ ${gstPercent}%`,val:`+‚Çπ${gstAmount.toLocaleString()}`,cls:'yellow'});}
  const calculatedWithGST=calculated+gstAmount;
  if(tollParking>0)breakdown.push({lbl:'Toll / Parking (GST exempt)',val:`+‚Çπ${tollParking.toLocaleString()}`,cls:'yellow'});
  const calculatedTotal=calculatedWithGST+tollParking;
  if(claimed>0){breakdown.push({divider:true});const diff=claimed-calculatedTotal;breakdown.push({lbl:'Vendor Claimed',val:`‚Çπ${claimed.toLocaleString()}`,cls:diff>0?'red':'green'});breakdown.push({lbl:'Calculated Total',val:`‚Çπ${calculatedTotal.toLocaleString()}`,cls:'green'});if(diff>0)notes.push(`Vendor claimed ‚Çπ${diff.toLocaleString()} more than calculated.`);if(diff<0)notes.push(`Vendor claimed ‚Çπ${Math.abs(diff).toLocaleString()} less than calculated.`);}
  const payable=claimed>0?Math.min(calculatedTotal,claimed):calculatedTotal;
  showResult(breakdown,payable,notes);
  currentCalc={vendor:getVendorName(),billNo:document.getElementById('billNo').value,billDate:document.getElementById('billDate').value,passengers:document.getElementById('passengers').value,destination:document.getElementById('destination').value,purposeOfVisit:getPurpose(),serviceType:svc,vehicleType:veh,journeyStart:startStr,journeyEnd:endStr,km:svc==='local'?(parseFloat(document.getElementById('localKm').value)||0):(parseFloat(document.getElementById('outstationKm').value)||0),hrs:svc==='local'?(parseFloat(document.getElementById('localHrs').value)||null):null,vendorClaimed:claimed||null,calculatedAmount:calculated,gstPercent:gstPercent||null,gstAmount:gstAmount||null,tollParking:tollParking||null,calculatedTotal,payableAmount:payable,notes,savedAt:new Date().toISOString(),id:Date.now()};
}

function showResult(breakdown,payable,notes){
  const card=document.getElementById('resultCard');
  const lines=document.getElementById('resultLines');
  card.classList.remove('hidden');
  document.getElementById('saveBtn').classList.remove('hidden');
  document.getElementById('payableAmount').textContent='‚Çπ'+payable.toLocaleString();
  lines.innerHTML=breakdown.map(b=>{
    if(b.divider)return`<hr class="divider-line"/>`;
    return`<div class="result-line"><span class="lbl">${b.lbl}</span><span class="val${b.cls?' '+b.cls:''}">${b.val}</span></div>`;
  }).join('');
  const nb=document.getElementById('noteBox');
  if(notes.length){nb.innerHTML=notes.map(n=>`‚Ä¢ ${n}`).join('<br/>');nb.classList.remove('hidden');}
  else nb.classList.add('hidden');
}
function hideResult(){document.getElementById('resultCard').classList.add('hidden');document.getElementById('saveBtn').classList.add('hidden');currentCalc=null;}

function saveEntry(){
  if(!currentCalc)return;
  entries.unshift(currentCalc);
  localStorage.setItem('travelbill_entries',JSON.stringify(entries));
  if(GOOGLE_SHEET_URL){fetch(GOOGLE_SHEET_URL,{method:'POST',body:JSON.stringify(currentCalc),headers:{'Content-Type':'text/plain;charset=utf-8'},mode:'no-cors'}).catch(()=>{});}
  const btn=document.getElementById('saveBtn');
  btn.innerHTML='‚úÖ Saved!';btn.style.background='linear-gradient(135deg,#059669,#0d9488)';
  setTimeout(()=>{btn.innerHTML='‚úì Save Entry';btn.style.background='';},2500);
  clearForm();
}

function clearForm(){['purposeOfVisit','vendorSelect','billDate','billNo','passengers','destination','serviceType','vehicleType','journeyStartDate','journeyStartTime','journeyEndDate','journeyEndTime','localKm','localHrs','outstationKm','vendorClaimed','gstPercent','tollParking'].forEach(id=>document.getElementById(id).value='');['vendorOther','purposeOther'].forEach(id=>{document.getElementById(id).value='';document.getElementById(id).classList.add('hidden');});['localFields','outstationFields'].forEach(id=>document.getElementById(id).classList.add('hidden'));hideResult();}

function svcLabel(s){return{local:'Local',outstation_plain:'Outstation (Plain)',outstation_hilly:'Outstation (Hilly)'}[s]||s;}
function fmtDt(str){if(!str)return'‚Äî';return new Date(str).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});}

function renderHistory(){
  const list=document.getElementById('historyList');
  const badge=document.getElementById('countBadge');
  badge.innerHTML=`<span>${entries.length}</span> entr${entries.length===1?'y':'ies'} saved`;
  if(!entries.length){list.innerHTML=`<div class="history-empty"><div class="icon">üöñ</div><div style="font-weight:700;font-size:1rem;">No entries saved yet.</div><div style="margin-top:8px;font-size:0.82rem;">Calculate and save a bill to see it here.</div></div>`;return;}
  list.innerHTML='';
  entries.forEach((e,i)=>{
    const item=document.createElement('div');item.className='history-item';item.id='hi_'+i;
    const diff=e.vendorClaimed?e.vendorClaimed-e.payableAmount:0;
    const diffTag=e.vendorClaimed?(diff>0?`<span class="tag">Saved ‚Çπ${Math.abs(diff).toLocaleString()}</span>`:diff<0?`<span class="tag green">Vendor Under-billed</span>`:''):'';
    item.innerHTML=`
      <div class="hi-top" onclick="toggleExpand(${i})">
        <div class="hi-meta">
          <div class="hi-bill">üöñ Bill #${e.billNo||'‚Äî'} ¬∑ ${e.billDate?new Date(e.billDate).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}):new Date(e.savedAt).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})}</div>
          <div class="hi-title">${e.vendor||'‚Äî'} ‚Üí ${e.destination||'‚Äî'}</div>
          <div class="hi-tags">
            <span class="tag">${svcLabel(e.serviceType)}</span>
            <span class="tag">${e.vehicleType==='sedan'?'üöó Sedan':'üöô Crysta'}</span>
            ${e.purposeOfVisit?`<span class="tag yellow">üéØ ${e.purposeOfVisit}</span>`:''}
            ${e.passengers?`<span class="tag teal">üë§ ${e.passengers}</span>`:''}
            ${diffTag}
          </div>
        </div>
        <div class="hi-amount"><div class="payable">‚Çπ${e.payableAmount.toLocaleString()}</div><div class="label">Payable</div></div>
      </div>
      <div class="hi-detail" id="hid_${i}">
        <div class="detail-grid">
          <div class="dg-item"><div class="dg-lbl">Bill No.</div><div class="dg-val">${e.billNo||'‚Äî'}</div></div>
          <div class="dg-item"><div class="dg-lbl">Bill Date</div><div class="dg-val">${e.billDate?new Date(e.billDate).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}):'‚Äî'}</div></div>
          <div class="dg-item"><div class="dg-lbl">Passengers</div><div class="dg-val">${e.passengers||'‚Äî'}</div></div>
          <div class="dg-item"><div class="dg-lbl">Purpose</div><div class="dg-val">${e.purposeOfVisit||'‚Äî'}</div></div>
          <div class="dg-item"><div class="dg-lbl">Destination</div><div class="dg-val">${e.destination||'‚Äî'}</div></div>
          <div class="dg-item"><div class="dg-lbl">Journey Start</div><div class="dg-val">${fmtDt(e.journeyStart)}</div></div>
          <div class="dg-item"><div class="dg-lbl">Journey End</div><div class="dg-val">${fmtDt(e.journeyEnd)}</div></div>
          <div class="dg-item"><div class="dg-lbl">Km Travelled</div><div class="dg-val">${e.km} km</div></div>
          ${e.hrs!=null?`<div class="dg-item"><div class="dg-lbl">Hours Used</div><div class="dg-val">${e.hrs} hrs</div></div>`:''}
          <div class="dg-item"><div class="dg-lbl">Vendor Claimed</div><div class="dg-val">‚Çπ${e.vendorClaimed?e.vendorClaimed.toLocaleString():'‚Äî'}</div></div>
          <div class="dg-item"><div class="dg-lbl">Transport Sub-total</div><div class="dg-val">‚Çπ${e.calculatedAmount.toLocaleString()}</div></div>
          ${e.gstPercent?`<div class="dg-item"><div class="dg-lbl">GST (${e.gstPercent}%)</div><div class="dg-val">‚Çπ${(e.gstAmount||0).toLocaleString()}</div></div>`:''}
          ${e.tollParking?`<div class="dg-item"><div class="dg-lbl">Toll / Parking</div><div class="dg-val">‚Çπ${e.tollParking.toLocaleString()}</div></div>`:''}
          <div class="dg-item"><div class="dg-lbl">Calculated Total</div><div class="dg-val">‚Çπ${(e.calculatedTotal||e.calculatedAmount).toLocaleString()}</div></div>
          <div class="dg-item" style="background:#fffbeb;border-color:#fde68a;"><div class="dg-lbl" style="color:#b45309;">Amount Payable</div><div class="dg-val" style="color:#d97706;font-size:1.1rem;">‚Çπ${e.payableAmount.toLocaleString()}</div></div>
        </div>
        ${e.notes&&e.notes.length?`<div class="note-box" style="margin-top:12px;">${e.notes.map(n=>`‚Ä¢ ${n}`).join('<br/>')}</div>`:''}
        <div class="hi-actions"><button class="btn btn-danger" onclick="deleteEntry(${i})">üóë Delete</button></div>
      </div>`;
    list.appendChild(item);
  });
}

function toggleExpand(i){const detail=document.getElementById('hid_'+i),item=document.getElementById('hi_'+i);const isOpen=detail.classList.contains('show');document.querySelectorAll('.hi-detail').forEach(d=>d.classList.remove('show'));document.querySelectorAll('.history-item').forEach(d=>d.classList.remove('expanded'));if(!isOpen){detail.classList.add('show');item.classList.add('expanded');}}
function deleteEntry(i){if(!confirm('Delete this entry?'))return;entries.splice(i,1);localStorage.setItem('travelbill_entries',JSON.stringify(entries));renderHistory();}
function exportCSV(){if(!entries.length){alert('No entries to export.');return;}const headers=['ID','Saved Date','Vendor','Bill No','Bill Date','Passengers','Purpose','Destination','Service','Vehicle','Journey Start','Journey End','Km','Hours','Vendor Claimed','Transport Sub-total','GST %','GST Amount','Toll/Parking','Calculated Total','Payable Amount'];const rows=entries.map(e=>[e.id,new Date(e.savedAt).toLocaleString('en-IN'),e.vendor,e.billNo,e.billDate||'',e.passengers,e.purposeOfVisit||'',e.destination,svcLabel(e.serviceType),e.vehicleType==='sedan'?'Sedan':'Crysta',fmtDt(e.journeyStart),fmtDt(e.journeyEnd),e.km,e.hrs??'',e.vendorClaimed,e.calculatedAmount,e.gstPercent??0,e.gstAmount??0,e.tollParking??0,e.calculatedTotal??e.calculatedAmount,e.payableAmount].map(v=>`"${String(v??'').replace(/"/g,'""')}"`));const csv=[headers.join(','),...rows.map(r=>r.join(','))].join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='travelbill_export.csv';a.click();}
function exportJSON(){if(!entries.length){alert('No entries to export.');return;}const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(entries,null,2)],{type:'application/json'}));a.download='travelbill_export.json';a.click();}
</script>
</body>
</html>
