<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Service Orders Tracking</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Plus Jakarta Sans',sans-serif;min-height:100vh;background:#f0f7f4;color:#1e293b;overflow-x:hidden;}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:#d1fae5;border-radius:3px;}
.hidden{display:none!important;}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav{display:flex;align-items:center;justify-content:space-between;padding:0 40px;height:64px;background:#fff;border-bottom:1.5px solid #d1fae5;position:sticky;top:0;z-index:100;}
.nav-left{display:flex;align-items:center;gap:14px;}
.back-btn{display:inline-flex;align-items:center;gap:6px;background:#f0fdf4;border:1.5px solid #bbf7d0;color:#059669;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.8rem;font-weight:700;padding:7px 16px;border-radius:10px;cursor:pointer;transition:all 0.2s;text-decoration:none;}
.back-btn:hover{background:#dcfce7;}
.nav-logo{display:flex;align-items:center;gap:10px;}
.logo-icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#10b981,#059669);display:flex;align-items:center;justify-content:center;font-size:1rem;box-shadow:0 4px 12px rgba(16,185,129,0.3);}
.nav-title{font-size:1rem;font-weight:800;color:#1e293b;}
.tab-pills{display:flex;gap:4px;background:#f0f7f4;border:1.5px solid #d1fae5;padding:4px;border-radius:12px;}
.tab-btn{background:none;border:none;color:#64748b;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.82rem;font-weight:700;padding:8px 20px;border-radius:9px;cursor:pointer;transition:all 0.2s;}
.tab-btn.active{background:#fff;color:#059669;box-shadow:0 1px 6px rgba(0,0,0,0.08);}
.tab-btn:hover:not(.active){color:#1e293b;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.page{display:none;max-width:860px;margin:0 auto;padding:36px 24px 80px;}
.page.active{display:block;animation:fadeUp 0.3s ease both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.section-header{background:#fff;border:1.5px solid #d1fae5;border-radius:18px;padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;gap:16px;box-shadow:0 2px 8px rgba(16,185,129,0.07);}
.sh-icon{width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,#10b981,#059669);display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;box-shadow:0 4px 12px rgba(16,185,129,0.25);}
.sh-title{font-size:1.15rem;font-weight:800;color:#1e293b;margin-bottom:3px;}
.sh-sub{font-size:0.82rem;color:#64748b;}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:#fff;border:1.5px solid #e2e8f0;border-radius:18px;padding:24px 26px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.04);}
.section-label{font-size:0.68rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#059669;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid #d1fae5;display:flex;align-items:center;gap:8px;}
.section-label .dot{width:6px;height:6px;border-radius:50%;background:#10b981;}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-row{display:grid;gap:14px;margin-bottom:14px;}
.form-row.col2{grid-template-columns:1fr 1fr;}
.form-row.col1{grid-template-columns:1fr;}
label{font-size:0.76rem;font-weight:700;color:#374151;display:block;margin-bottom:5px;}
label .opt{font-weight:500;color:#94a3b8;font-size:0.7rem;}
input,select,textarea{width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;color:#1e293b;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.9rem;padding:11px 14px;border-radius:10px;outline:none;transition:all 0.2s;}
input:focus,select:focus,textarea:focus{border-color:#10b981;background:#f0fdf4;box-shadow:0 0 0 3px rgba(16,185,129,0.1);}
input::placeholder,textarea::placeholder{color:#cbd5e1;}
textarea{resize:vertical;min-height:80px;}
.status-preview{border-radius:10px;padding:12px 16px;font-size:0.88rem;font-weight:700;display:flex;align-items:center;gap:10px;margin-top:8px;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-row{display:flex;gap:10px;margin-top:4px;}
.btn{font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:0.88rem;padding:11px 24px;border-radius:10px;border:none;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:7px;}
.btn-success{background:linear-gradient(135deg,#10b981,#059669);color:#fff;box-shadow:0 4px 14px rgba(16,185,129,0.3);}
.btn-success:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(16,185,129,0.4);}
.btn-success:disabled{opacity:0.7;transform:none;}
.btn-outline{background:#f8fafc;border:1.5px solid #e2e8f0;color:#64748b;}
.btn-outline:hover{background:#f1f5f9;color:#1e293b;}
.btn-danger{background:#fef2f2;border:1.5px solid #fecaca;color:#ef4444;font-size:0.8rem;padding:7px 14px;}
.btn-danger:hover{background:#fee2e2;}
.btn-sm{font-size:0.75rem;padding:7px 14px;}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.stat-card{background:#fff;border:1.5px solid #e2e8f0;border-radius:16px;padding:18px;box-shadow:0 1px 6px rgba(0,0,0,0.04);position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.stat-total::before{background:linear-gradient(90deg,#6366f1,#8b5cf6);}
.stat-active::before{background:linear-gradient(90deg,#10b981,#06b6d4);}
.stat-warn60::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
.stat-warn30::before{background:linear-gradient(90deg,#ef4444,#f87171);}
.stat-val{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;line-height:1;margin-bottom:4px;}
.stat-total .stat-val{color:#6366f1;}
.stat-active .stat-val{color:#10b981;}
.stat-warn60 .stat-val{color:#f59e0b;}
.stat-warn30 .stat-val{color:#ef4444;}
.stat-lbl{font-size:0.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;}

/* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
.filter-bar{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.filter-btn{background:#fff;border:1.5px solid #e2e8f0;color:#64748b;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.78rem;font-weight:700;padding:7px 16px;border-radius:20px;cursor:pointer;transition:all 0.2s;}
.filter-btn:hover{border-color:#10b981;color:#059669;}
.filter-btn.active{background:#ecfdf5;border-color:#6ee7b7;color:#059669;}
.f-warn60.active{background:#fffbeb;border-color:#fcd34d;color:#b45309;}
.f-warn30.active{background:#fef2f2;border-color:#fca5a5;color:#dc2626;}
.f-expired.active{background:#f8fafc;border-color:#e2e8f0;color:#94a3b8;}

/* ‚îÄ‚îÄ LIST HEADER ‚îÄ‚îÄ */
.list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding:12px 18px;background:#fff;border:1.5px solid #e2e8f0;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,0.04);}
.list-count{font-size:0.85rem;font-weight:700;color:#1e293b;}
.list-count span{color:#10b981;}
#sheetStatus{font-size:0.72rem;font-family:'JetBrains Mono',monospace;color:#10b981;}

/* ‚îÄ‚îÄ CONTRACT ITEMS ‚îÄ‚îÄ */
.contract-item{background:#fff;border:1.5px solid #e2e8f0;border-radius:16px;margin-bottom:10px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.04);}
.contract-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:4px 0 0 4px;}
.status-active::before{background:#10b981;}
.status-warn60::before{background:#f59e0b;}
.status-warn30::before{background:#ef4444;}
.status-expired::before{background:#e2e8f0;}
.contract-item:hover{border-color:#bbf7d0;box-shadow:0 4px 16px rgba(16,185,129,0.1);transform:translateY(-1px);}
.contract-item.expanded{border-color:#6ee7b7;box-shadow:0 4px 20px rgba(16,185,129,0.12);}
.ci-top{padding:18px 20px 18px 24px;display:flex;justify-content:space-between;align-items:flex-start;gap:16px;}
.ci-contract{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:#10b981;margin-bottom:5px;font-weight:600;}
.ci-title{font-weight:800;font-size:0.98rem;color:#1e293b;margin-bottom:8px;}
.ci-tags{display:flex;gap:6px;flex-wrap:wrap;}
.tag{font-size:0.68rem;font-weight:700;padding:3px 10px;border-radius:20px;}
.tag-active{background:#dcfce7;color:#166534;}
.tag-warn60{background:#fef9c3;color:#854d0e;}
.tag-warn30{background:#fee2e2;color:#991b1b;}
.tag-expired{background:#f1f5f9;color:#64748b;}
.tag-date{background:#f0f9ff;color:#0369a1;}
.days-chip{font-family:'JetBrains Mono',monospace;font-size:0.82rem;font-weight:700;padding:6px 14px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
.days-active{background:#dcfce7;color:#166534;}
.days-warn60{background:#fef9c3;color:#854d0e;}
.days-warn30{background:#fee2e2;color:#991b1b;}
.days-expired{background:#f1f5f9;color:#94a3b8;}

/* ‚îÄ‚îÄ EXPANDED DETAIL ‚îÄ‚îÄ */
.ci-detail{display:none;padding:0 20px 18px 24px;border-top:1.5px solid #f0f7f4;}
.ci-detail.show{display:block;animation:fadeUp 0.2s ease both;}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:14px;}
.dg-item{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:10px 14px;}
.dg-lbl{font-size:0.66rem;color:#94a3b8;margin-bottom:3px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;}
.dg-val{font-size:0.88rem;font-weight:700;color:#1e293b;}
.remarks-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px 14px;margin-top:8px;}
.remarks-text{font-size:0.88rem;color:#374151;margin-top:4px;}
.ci-actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end;}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.list-empty{text-align:center;padding:60px 20px;color:#94a3b8;}
.list-empty .icon{font-size:3rem;margin-bottom:14px;}
.list-empty p{font-size:0.82rem;margin-top:6px;}

/* ‚îÄ‚îÄ BG BLOBS ‚îÄ‚îÄ */
.bg-blob{position:fixed;border-radius:50%;filter:blur(80px);pointer-events:none;z-index:0;}
.blob1{width:450px;height:450px;background:rgba(16,185,129,0.07);top:-100px;right:-80px;}
.blob2{width:350px;height:350px;background:rgba(6,182,212,0.05);bottom:-60px;left:-60px;}

@media(max-width:640px){
  nav{padding:0 16px;height:56px;}
  .page{padding:24px 16px 60px;}
  .form-row.col2{grid-template-columns:1fr;}
  .stats-row{grid-template-columns:1fr 1fr;}
  .detail-grid{grid-template-columns:1fr;}
  .tab-btn{padding:7px 12px;font-size:0.78rem;}
}
</style>
</head>
<body>

<div class="bg-blob blob1"></div>
<div class="bg-blob blob2"></div>

<div style="position:relative;z-index:1;">
<nav>
  <div class="nav-left">
    <a class="back-btn" href="index.html">‚Üê Home</a>
    <div class="nav-logo">
      <div class="logo-icon">üìã</div>
      <span class="nav-title">Service Orders Tracking</span>
    </div>
  </div>
  <div class="tab-pills">
    <button class="tab-btn active" onclick="showTab('add',this)">‚ûï Add Contract</button>
    <button class="tab-btn" onclick="showTab('list',this)">üìÑ All Contracts</button>
  </div>
</nav>

<!-- ADD PAGE -->
<div class="page active" id="tab-add">
  <div class="section-header">
    <div class="sh-icon">üìù</div>
    <div>
      <div class="sh-title">Add New Contract</div>
      <div class="sh-sub">Register a GeM service contract for tracking and expiry monitoring.</div>
    </div>
  </div>
  <div class="card">
    <div class="section-label"><span class="dot"></span>Contract Details</div>
    <div class="form-row col2">
      <div><label>GeM Contract Number</label><input type="text" id="gemNumber" placeholder="e.g. GEMC-511687755"/></div>
      <div><label>Type of Service</label><input type="text" id="serviceType" placeholder="e.g. Housekeeping, Security"/></div>
    </div>
    <div class="form-row col2">
      <div><label>Vendor Name</label><input type="text" id="vendorName" placeholder="e.g. ABC Services Pvt. Ltd."/></div>
      <div><label>Contract Value (‚Çπ) <span class="opt">Optional</span></label><input type="number" id="contractValue" placeholder="e.g. 500000"/></div>
    </div>
    <div class="form-row col2">
      <div><label>Contract Start Date</label><input type="date" id="startDate"/></div>
      <div><label>Contract End Date</label><input type="date" id="endDate" onchange="previewStatus()"/></div>
    </div>
    <div class="form-row col1">
      <div><label>Remarks <span class="opt">Optional</span></label><textarea id="remarks" placeholder="Any additional notes‚Ä¶"></textarea></div>
    </div>
    <div id="statusPreview" class="status-preview hidden"></div>
  </div>
  <div class="btn-row">
    <button class="btn btn-success" onclick="saveContract()">‚úì Save Contract</button>
    <button class="btn btn-outline" onclick="clearForm()">‚úï Clear</button>
  </div>
</div>

<!-- LIST PAGE -->
<div class="page" id="tab-list">
  <div class="section-header">
    <div class="sh-icon">üìä</div>
    <div>
      <div class="sh-title">All Contracts</div>
      <div class="sh-sub">Monitor active services, track expiry dates, and manage renewals.</div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-card stat-total">
      <div class="stat-val" id="statTotal">0</div>
      <div class="stat-lbl">Total</div>
    </div>
    <div class="stat-card stat-active">
      <div class="stat-val" id="statActive">0</div>
      <div class="stat-lbl">Active</div>
    </div>
    <div class="stat-card stat-warn60">
      <div class="stat-val" id="statWarn60">0</div>
      <div class="stat-lbl">Expiring &lt;60d</div>
    </div>
    <div class="stat-card stat-warn30">
      <div class="stat-val" id="statWarn30">0</div>
      <div class="stat-lbl">Expiring &lt;30d</div>
    </div>
  </div>

  <div class="filter-bar">
    <button class="filter-btn active" onclick="filterContracts('all',this)">All</button>
    <button class="filter-btn" onclick="filterContracts('active',this)">‚úÖ Active</button>
    <button class="filter-btn f-warn60" onclick="filterContracts('warn60',this)">‚ö†Ô∏è &lt;60 Days</button>
    <button class="filter-btn f-warn30" onclick="filterContracts('warn30',this)">üî¥ &lt;30 Days</button>
    <button class="filter-btn f-expired" onclick="filterContracts('expired',this)">‚õî Expired</button>
  </div>

  <div class="list-header">
    <span class="list-count" id="listCount"><span>0</span> contracts</span>
    <div style="display:flex;gap:8px;align-items:center;">
      <span id="sheetStatus"></span>
      <button class="btn btn-outline btn-sm" onclick="loadFromSheet()">‚Üª Sync Sheet</button>
      <button class="btn btn-outline btn-sm" onclick="exportCSV()">‚Üì CSV</button>
    </div>
  </div>

  <div id="contractList"></div>
</div>
</div>

<script>
const SHEET_URL='https://script.google.com/macros/s/AKfycbzK-H-Od7OIRDHNsRfjRp5adjm0SsrZmjgrlBtnsiyvKqTeZCyWkxu8dPm9Zxca3qvw/exec';
let contracts=JSON.parse(localStorage.getItem('service_contracts')||'[]');
let currentFilter='all';
let sheetLoaded=false;

// ‚îÄ‚îÄ SYNC FROM GOOGLE SHEET (JSONP) ‚îÄ‚îÄ
function loadFromSheet(){
  const st=document.getElementById('sheetStatus');
  const set=(msg,col)=>{if(!st)return;st.textContent=msg;st.style.color=col||'#10b981';};
  set('‚è≥ Syncing‚Ä¶','#f59e0b');
  const cbName='_cb'+Date.now();
  const script=document.createElement('script');
  let done=false;
  const cleanup=()=>{try{delete window[cbName];}catch(e){}try{if(script.parentNode)document.head.removeChild(script);}catch(e){}};
  const finish=(msg,col,data)=>{
    if(done)return;done=true;clearTimeout(timer);cleanup();
    set(msg,col);setTimeout(()=>set('',''),6000);
    sheetLoaded=true;
    if(data&&Array.isArray(data)&&data.length>0){contracts=data;localStorage.setItem('service_contracts',JSON.stringify(contracts));}
    renderContracts();
  };
  const timer=setTimeout(()=>finish('‚è± Timed out ‚Äî check deployment','#ef4444',null),12000);
  window[cbName]=function(data){
    if(Array.isArray(data)&&data.length===0)return finish('üìã Sheet is empty','#f59e0b',data);
    if(!data||data.error)return finish('‚ö†Ô∏è Error: '+(data&&data.error||'unknown'),'#ef4444',null);
    finish('‚úÖ Synced '+data.length+' contracts','#10b981',data);
  };
  script.addEventListener('error',()=>finish('‚ùå Script error ‚Äî check Apps Script','#ef4444',null));
  script.src=SHEET_URL+'?action=getAll&callback='+cbName;
  document.head.appendChild(script);
}

// ‚îÄ‚îÄ POST TO SHEET ‚îÄ‚îÄ
function postToSheet(entry,btn,origHTML){
  fetch(SHEET_URL,{method:'POST',body:JSON.stringify(entry),headers:{'Content-Type':'text/plain;charset=utf-8'},mode:'no-cors'})
  .then(()=>{btn.innerHTML='‚úÖ Sent to Sheet!';btn.style.background='linear-gradient(135deg,#059669,#0d9488)';setTimeout(()=>{btn.innerHTML=origHTML;btn.style.background='';btn.disabled=false;},3000);})
  .catch(()=>{btn.innerHTML='üíæ Saved locally';setTimeout(()=>{btn.innerHTML=origHTML;btn.style.background='';btn.disabled=false;},2500);});
}

function showTab(name,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(el)el.classList.add('active');
  if(name==='list'){if(!sheetLoaded)loadFromSheet();else renderContracts();}
}

function calcStatus(endDateStr){
  if(!endDateStr)return{status:'unknown',days:null};
  const today=new Date();today.setHours(0,0,0,0);
  const end=new Date(endDateStr);end.setHours(0,0,0,0);
  const diff=Math.ceil((end-today)/86400000);
  if(diff<0)return{status:'expired',days:diff};
  if(diff<30)return{status:'warn30',days:diff};
  if(diff<60)return{status:'warn60',days:diff};
  return{status:'active',days:diff};
}

function statusText(status,days){
  if(status==='expired')return`‚õî Expired (${Math.abs(days)}d ago)`;
  if(status==='warn30')return`üî¥ Expiring in ${days} day${days===1?'':'s'}`;
  if(status==='warn60')return`‚ö†Ô∏è Expiring in ${days} days`;
  if(status==='active')return`‚úÖ Active ‚Äî ${days} days left`;
  return'‚Äî';
}

function previewStatus(){
  const endDate=document.getElementById('endDate').value;
  const preview=document.getElementById('statusPreview');
  if(!endDate){preview.classList.add('hidden');return;}
  const{status,days}=calcStatus(endDate);
  const styles={
    active:'background:#dcfce7;border:1.5px solid #6ee7b7;color:#166534;',
    warn60:'background:#fef9c3;border:1.5px solid #fde68a;color:#92400e;',
    warn30:'background:#fee2e2;border:1.5px solid #fca5a5;color:#991b1b;',
    expired:'background:#f1f5f9;border:1.5px solid #e2e8f0;color:#94a3b8;'
  };
  preview.style.cssText=(styles[status]||styles.expired)+'border-radius:10px;padding:12px 16px;font-size:0.88rem;font-weight:700;display:flex;align-items:center;gap:10px;margin-top:8px;';
  preview.textContent=statusText(status,days);
  preview.classList.remove('hidden');
}

function saveContract(){
  const gemNumber=document.getElementById('gemNumber').value.trim();
  const serviceType=document.getElementById('serviceType').value.trim();
  const vendorName=document.getElementById('vendorName').value.trim();
  const startDate=document.getElementById('startDate').value;
  const endDate=document.getElementById('endDate').value;
  const contractValue=document.getElementById('contractValue').value;
  const remarks=document.getElementById('remarks').value.trim();
  if(!gemNumber){alert('Please enter GeM Contract Number.');return;}
  if(!serviceType){alert('Please enter Type of Service.');return;}
  if(!vendorName){alert('Please enter Vendor Name.');return;}
  if(!startDate){alert('Please select Contract Start Date.');return;}
  if(!endDate){alert('Please select Contract End Date.');return;}
  const{status,days}=calcStatus(endDate);
  const entry={id:Date.now(),savedAt:new Date().toISOString(),gemNumber,serviceType,vendorName,startDate,endDate,contractValue:contractValue||'',remarks,status,days};
  contracts.unshift(entry);
  localStorage.setItem('service_contracts',JSON.stringify(contracts));
  const btn=document.querySelector('.btn-success');
  const orig=btn.innerHTML;
  btn.innerHTML='‚è≥ Saving‚Ä¶';btn.disabled=true;
  clearForm();
  postToSheet(entry,btn,orig);
}

function clearForm(){['gemNumber','serviceType','vendorName','startDate','endDate','contractValue','remarks'].forEach(id=>document.getElementById(id).value='');document.getElementById('statusPreview').classList.add('hidden');}
function filterContracts(filter,el){currentFilter=filter;document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderContracts();}
function getFiltered(){const r=contracts.map(c=>({...c,...calcStatus(c.endDate)}));if(currentFilter==='all')return r;return r.filter(c=>c.status===currentFilter);}
function fmtDate(str){if(!str)return'‚Äî';try{return new Date(str).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});}catch(e){return str;}}
function fmtCurrency(val){return val?'‚Çπ'+Number(val).toLocaleString('en-IN'):'‚Äî';}

function renderContracts(){
  const list=document.getElementById('contractList');
  const filtered=getFiltered();
  const all=contracts.map(c=>({...c,...calcStatus(c.endDate)}));
  document.getElementById('statTotal').textContent=all.length;
  document.getElementById('statActive').textContent=all.filter(c=>c.status==='active').length;
  document.getElementById('statWarn60').textContent=all.filter(c=>c.status==='warn60').length;
  document.getElementById('statWarn30').textContent=all.filter(c=>c.status==='warn30'||c.status==='warn30').length;
  document.getElementById('listCount').innerHTML=`<span>${filtered.length}</span> contract${filtered.length===1?'':'s'}`;
  if(!filtered.length){list.innerHTML=`<div class="list-empty"><div class="icon">üìã</div><div style="font-weight:700;color:#374151;">No contracts found.</div><p>Add a contract or click Sync Sheet to load from Google Sheets.</p></div>`;return;}
  const tagClass={active:'tag-active',warn60:'tag-warn60',warn30:'tag-warn30',expired:'tag-expired'};
  const chipClass={active:'days-active',warn60:'days-warn60',warn30:'days-warn30',expired:'days-expired'};
  list.innerHTML='';
  filtered.forEach(c=>{
    const item=document.createElement('div');
    item.className=`contract-item status-${c.status}`;item.id='ci_'+c.id;
    item.innerHTML=`
      <div class="ci-top" onclick="toggleExpand('${c.id}')">
        <div class="ci-meta">
          <div class="ci-contract">üìÑ ${c.gemNumber}</div>
          <div class="ci-title">${c.serviceType} ‚Äî ${c.vendorName}</div>
          <div class="ci-tags">
            <span class="tag ${tagClass[c.status]||''}">${statusText(c.status,c.days)}</span>
            <span class="tag tag-date">üìÖ Ends ${fmtDate(c.endDate)}</span>
          </div>
        </div>
        <div class="ci-right"><div class="days-chip ${chipClass[c.status]||''}">${c.days<0?'Expired':c.days+'d left'}</div></div>
      </div>
      <div class="ci-detail" id="cid_${c.id}">
        <div class="detail-grid">
          <div class="dg-item"><div class="dg-lbl">GeM Contract No.</div><div class="dg-val">${c.gemNumber}</div></div>
          <div class="dg-item"><div class="dg-lbl">Type of Service</div><div class="dg-val">${c.serviceType}</div></div>
          <div class="dg-item"><div class="dg-lbl">Vendor Name</div><div class="dg-val">${c.vendorName}</div></div>
          <div class="dg-item"><div class="dg-lbl">Contract Value</div><div class="dg-val">${fmtCurrency(c.contractValue)}</div></div>
          <div class="dg-item"><div class="dg-lbl">Start Date</div><div class="dg-val">${fmtDate(c.startDate)}</div></div>
          <div class="dg-item"><div class="dg-lbl">End Date</div><div class="dg-val">${fmtDate(c.endDate)}</div></div>
          <div class="dg-item"><div class="dg-lbl">Days Remaining</div><div class="dg-val" style="color:${c.status==='warn30'?'#ef4444':c.status==='warn60'?'#f59e0b':c.status==='expired'?'#94a3b8':'#10b981'}">${c.days<0?'Expired '+Math.abs(c.days)+'d ago':c.days+' days'}</div></div>
          <div class="dg-item"><div class="dg-lbl">Added On</div><div class="dg-val">${new Date(c.savedAt).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})}</div></div>
        </div>
        ${c.remarks?`<div class="remarks-box"><div class="dg-lbl">Remarks</div><div class="remarks-text">${c.remarks}</div></div>`:''}
        <div class="ci-actions"><button class="btn btn-danger" onclick="deleteContract('${c.id}')">üóë Delete</button></div>
      </div>`;
    list.appendChild(item);
  });
}

function toggleExpand(id){const detail=document.getElementById('cid_'+id);const item=document.getElementById('ci_'+id);const isOpen=detail.classList.contains('show');document.querySelectorAll('.ci-detail').forEach(d=>d.classList.remove('show'));document.querySelectorAll('.contract-item').forEach(d=>d.classList.remove('expanded'));if(!isOpen){detail.classList.add('show');item.classList.add('expanded');}}
function deleteContract(id){if(!confirm('Delete this contract?'))return;contracts=contracts.filter(c=>String(c.id)!==String(id));localStorage.setItem('service_contracts',JSON.stringify(contracts));renderContracts();}
function exportCSV(){if(!contracts.length){alert('No contracts to export.');return;}const headers=['ID','Saved Date','GeM Contract No.','Type of Service','Vendor Name','Contract Value','Start Date','End Date','Days Remaining','Status','Remarks'];const rows=contracts.map(c=>{const{status,days}=calcStatus(c.endDate);return[c.id,new Date(c.savedAt).toLocaleDateString('en-IN'),c.gemNumber,c.serviceType,c.vendorName,c.contractValue||'',fmtDate(c.startDate),fmtDate(c.endDate),days,status,c.remarks||''].map(v=>`"${String(v??'').replace(/"/g,'""')}"`)});const csv=[headers.join(','),...rows.map(r=>r.join(','))].join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='service_contracts.csv';a.click();}

window.addEventListener('DOMContentLoaded',()=>{renderContracts();loadFromSheet();});
</script>
</body>
</html>
